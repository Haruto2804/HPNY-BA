<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Journey | Memory Studio v8.0</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;600;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary-bao: #0ea5e9;
      --primary-na: #f472b6;
      --bg-dark: #020617;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-dark);
      color: #f8fafc;
      overflow: hidden;
      height: 100vh;
      margin: 0;
    }

    #threejs-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
    }

    .reveal-text {
      opacity: 0;
      transform: translateY(20px);
      filter: blur(10px);
      transition: all 1s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .reveal-active {
      opacity: 1 !important;
      transform: translateY(0) !important;
      filter: blur(0) !important;
    }

    .heartbeat-slow {
      animation: pulseSlow 4s ease-in-out infinite;
    }

    @keyframes pulseSlow {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.04);
      }
    }

    .page {
      display: none;
      width: 100%;
      min-height: 100%;
      position: relative;
      z-index: 10;
    }

    .page.active {
      display: flex;
      flex-direction: column;
    }

    .bento-card {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(25px);
    }

    .nav-link.active {
      border-left: 5px solid white;
      background: rgba(255, 255, 255, 0.08);
      opacity: 1 !important;
    }

    #sidebar {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }

    @media (max-width: 768px) {
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        height: 100vh;
        width: 280px;
        box-shadow: 20px 0 50px rgba(0, 0, 0, 0.5);
      }

      #sidebar.open {
        transform: translateX(0);
      }

      #sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 90;
      }

      #sidebar.open+#sidebar-overlay {
        display: block;
      }

      #floating-player {
        left: 1rem !important;
        right: 1rem !important;
        width: auto !important;
        bottom: 1rem !important;
      }
    }

    .timeline-container {
      position: relative;
      width: 100%;
      margin-top: 2rem;
    }

    .timeline-line {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 100%;
      background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.1) 10%, rgba(255, 255, 255, 0.1) 90%, transparent);
    }

    .timeline-dot {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 40px);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      z-index: 20;
    }

    @media (max-width: 768px) {
      .timeline-line {
        left: 20px !important;
        transform: none !important;
      }

      .timeline-dot {
        left: 20px !important;
        transform: translateY(40px) !important;
      }

      .memory-row {
        flex-direction: column !important;
        padding-left: 45px !important;
        align-items: flex-start !important;
      }

      .memory-card-wrapper {
        width: 100% !important;
        padding: 0 !important;
      }
    }

    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .disk-rotate {
      animation: rotate 12s linear infinite;
    }

    .music-paused {
      animation-play-state: paused;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
      }

      50% {
        box-shadow: 0 0 40px rgba(14, 165, 233, 0.5);
      }
    }

    .playing-glow {
      animation: glow 3s infinite ease-in-out;
      border-color: rgba(14, 165, 233, 0.8) !important;
    }

    #floating-player {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 350px;
      z-index: 200;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform: scale(0.9) translateY(20px);
      opacity: 0;
    }

    #floating-player.show {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .wave-bar {
      width: 3px;
      height: 8px;
      background: #0ea5e9;
      border-radius: 2px;
    }

    .wave-active {
      animation: wave-anim 0.6s infinite alternate;
    }

    @keyframes wave-anim {
      from {
        height: 4px;
      }

      to {
        height: 14px;
      }
    }

    /* Container bao quanh khung h√¨nh ƒë·ªÉ gi·ªØ t·ªâ l·ªá */
    .aspect-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      /* ƒê√¢y l√† t·ªâ l·ªá 16:9 (9 / 16 * 100). D√πng cho video ngang/live */
      height: 0;
      overflow: hidden;
      border-radius: 1.5rem;
      background: #000;
    }

    /* Class n√†y s·∫Ω ƒë∆∞·ª£c th√™m v√†o khi h·ªá th·ªëng nh·∫≠n di·ªán l√† YouTube Shorts */
    .aspect-shorts {
      padding-bottom: 177.77%;
      /* ƒê√¢y l√† t·ªâ l·ªá 9:16 (16 / 9 * 100). D√πng cho video d·ªçc */
      max-width: 380px;
      /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ Shorts kh√¥ng b·ªã tr√†n m√†n h√¨nh PC */
      margin: 0 auto;
      /* CƒÉn gi·ªØa video d·ªçc */
    }

    /* √âp Iframe YouTube l·∫•p ƒë·∫ßy container ph√≠a tr√™n */
    .aspect-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .video-wrapper {
      width: 100%;
      max-width: 800px;
      /* ƒê·ªô r·ªông t·ªëi ƒëa c·ªßa khung video tr√™n m√†n h√¨nh l·ªõn */
      margin: 0 auto;
      /* CƒÉn gi·ªØa to√†n b·ªô c·ª•m video */
    }

    /* Khung ph√°t nh·∫°c m·∫∑c ƒë·ªãnh */
    /* --- CSS THU G·ªåN THANH NH·∫†C (GI·ªÆ NGUY√äN C√ÅC PH·∫¶N KH√ÅC) --- */

    #floating-player {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      /* ƒê·ªô r·ªông m·∫∑c ƒë·ªãnh khi m·ªü r·ªông */
      width: 350px;
      height: 90px;
      z-index: 200;
      /* Hi·ªáu ·ª©ng co gi√£n m∆∞·ª£t m√† cho c·∫£ background */
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      display: flex;
      align-items: center;
      padding: 1rem;
    }

    /* Khi c√≥ class .collapsed, to√†n b·ªô khung n·ªÅn s·∫Ω co l·∫°i */
    #floating-player.collapsed {
      width: 90px !important;
      /* Thu nh·ªè background v·ª´a ƒë·ªß √¥m ƒëƒ©a nh·∫°c */
      height: 90px;
      padding: 12px;
    }

    /* ƒêi·ªÅu ch·ªânh ph·∫ßn th√¥ng tin b√†i h√°t */
    .player-info {
      flex: 1;
      margin-left: 1rem;
      transition: opacity 0.3s ease, transform 0.3s ease;
      min-width: 240px;
      /* Gi·ªØ c·∫•u tr√∫c kh√¥ng b·ªã v·ª° khi ƒëang co gi√£n */
    }

    /* ·∫®n bi·∫øn m·∫•t th√¥ng tin khi thu g·ªçn */
    #floating-player.collapsed .player-info {
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }

    /* N√∫t X/N·ªët nh·∫°c ƒë·ªÉ ƒë√≥ng m·ªü */
    .toggle-player-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
      z-index: 10;
      transition: color 0.3s;
    }

    .toggle-player-btn:hover {
      color: white;
    }

    /* Responsive cho ƒëi·ªán tho·∫°i */
    @media (max-width: 768px) {
      #floating-player {
        right: 1rem;
        left: 1rem;
        /* Khi m·ªü r·ªông th√¨ chi·∫øm g·∫ßn h·∫øt chi·ªÅu ngang mobile */
        /* Full m√†n h√¨nh mobile khi m·ªü */
        bottom: 1rem;
        width: auto;
      }

      #floating-player.collapsed {
        /* Khi thu g·ªçn tr√™n mobile, b·ªè left: 1rem ƒë·ªÉ n√≥ co v·ªÅ b√™n ph·∫£i */
        left: auto !important;
        width: 90px !important;
      }
    }

    /* T·ªëi ∆∞u khung video hi·ªÉn th·ªã to tr√™n ƒëi·ªán tho·∫°i */
    @media (max-width: 768px) {
      .video-card-container {
        padding: 0.75rem !important;
        /* Gi·∫£m padding ƒë·ªÉ video c√≥ nhi·ªÅu kh√¥ng gian h∆°n */
      }

      .video-wrapper-mobile {
        width: 100% !important;
        max-width: 100% !important;
        aspect-ratio: 16/9;
        /* √âp t·ªâ l·ªá chu·∫©n video ngang */
      }

      /* N·∫øu l√† video d·ªçc (Shorts) th√¨ hi·ªán to h∆°n */
      .aspect-shorts-mobile {
        aspect-ratio: 9/16 !important;
        max-width: 90% !important;
        /* Chi·∫øm 90% chi·ªÅu ngang m√†n h√¨nh */
        margin: 0 auto;
      }
    }
  </style>
</head>

<body class="flex flex-col md:flex-row">
  <canvas id="threejs-canvas"></canvas>

  <div id="login-overlay" class="fixed inset-0 bg-slate-950 z-[200] flex items-center justify-center p-6 text-center">
    <div class="max-w-md w-full">
      <h2 class="text-4xl font-black mb-12 italic text-white tracking-tighter">X√°c nh·∫≠n danh t√≠nh</h2>
      <div id="profile-select" class="grid grid-cols-2 gap-6">
        <button onclick="selectUser('bao')" class="p-8 bento-card rounded-[2.5rem] hover:border-sky-500 transition-all">
          <img src="./src/images/Haruto.png"
            class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-sky-500 object-c over">
          <span class="font-bold text-sky-400 uppercase text-sm">B·∫£o</span>
        </button>
        <button onclick="selectUser('baoanh')"
          class="p-8 bento-card rounded-[2.5rem] hover:border-pink-500 transition-all">
          <img src="./src/images/BaoAnh.jpg"
            class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-pink-500 object-cover">
          <span class="font-bold text-pink-400 uppercase text-sm">B·∫£o Anh</span>
        </button>
      </div>
      <div id="password-box" class="hidden mt-8">
        <div class="relative mb-4">
          <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u..."
            class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-center text-xl outline-none text-white">
          <button onclick="togglePassword('login-password')"
            class="absolute right-5 top-1/2 -translate-y-1/2 opacity-30 hover:opacity-100">üëÅÔ∏è</button>
        </div>
        <button id="btn-login-verify"
          class="w-full bg-white text-black py-5 rounded-2xl font-bold uppercase tracking-widest text-sm">V√†o
          Studio</button>
      </div>
    </div>
  </div>

  <div
    class="md:hidden flex items-center justify-between p-5 bg-black/50 backdrop-blur-md border-b border-white/5 z-50">
    <span class="font-black italic text-lg text-sky-400">STUDIO</span>
    <button onclick="toggleSidebar()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke-width="2" stroke="currentColor" class="w-9 h-9 text-white">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg></button>
  </div>

  <aside id="sidebar"
    class="bg-[#020617] md:bg-black/20 md:backdrop-blur-xl border-r border-white/5 p-6 flex flex-col gap-8 w-full md:w-[300px]">
    <div class="flex justify-center items-center gap-5 px-2">
      <div id="user-avatar" class="w-[100px] h-14 rounded-[1.2rem] overflow-hidden border-2 border-white/10 shadow-2xl">
      </div>
      <h1 id="user-greeting" class="font-extrabold text-xl italic text-white truncate w-full">Ch√†o!</h1>
    </div>
    <nav class="flex flex-col gap-4 mt-10">
      <button onclick="switchPage('home', this)"
        class="nav-link active p-5 rounded-2xl text-md font-bold text-left text-white">üè† Trang ch·ªß</button>
      <button onclick="switchPage('timeline', this)"
        class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üìÖ Timeline</button>
      <button onclick="switchPage('video-memories', this)"
        class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üé¨ Video Clips</button>
      <button onclick="switchPage('media-gallery', this)"
        class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üñºÔ∏è ·∫¢nh</button>
      <button onclick="switchPage('music-lab', this)"
        class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üéµ Music Lab</button>
      <button onclick="document.getElementById('change-pw-modal').classList.remove('hidden')"
        class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üîë M·∫≠t kh·∫©u</button>
      <button onclick="sessionStorage.clear(); window.location.reload();"
        class="mt-auto p-5 text-xs font-bold opacity-30 text-white uppercase text-left">ƒêƒÉng xu·∫•t</button>
    </nav>
  </aside>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div id="floating-player" class="bento-card p-4 rounded-[2rem] border border-white/10 shadow-2xl show relative">
    <div onclick="togglePlayerSize()" class="toggle-player-btn">
      <span id="toggle-icon">‚úï</span>
    </div>

    <div class="flex items-center gap-4">
      <div id="music-disk"
        class="w-16 h-16 rounded-full border-2 border-white/20 shadow-lg overflow-hidden disk-rotate music-paused flex-shrink-0 transition-all duration-700">
        <img src="https://cdn-icons-png.flaticon.com/512/6048/6048452.png" class="w-full h-full object-cover">
      </div>

      <div class="player-info flex-1 overflow-hidden text-left">
        <div class="flex items-center gap-2 mb-1">
          <p id="current-song-title" class="text-[11px] font-black text-white truncate uppercase tracking-[0.1em]">ƒêang
            t·∫£i...</p>
        </div>
        <p id="current-song-author" class="text-[9px] text-slate-500 uppercase">G·ª≠i b·ªüi: ---</p>

        <div class="flex items-center gap-5 mt-3">
          <button onclick="prevSong()" class="text-white opacity-40 hover:opacity-100 transition-opacity"><svg
              class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
            </svg></button>
          <button onclick="toggleMusic()" id="play-btn"
            class="w-9 h-9 bg-white text-black rounded-full flex items-center justify-center shadow-lg">‚ñ∂</button>
          <button onclick="nextSong()" class="text-white opacity-40 hover:opacity-100 transition-opacity"><svg
              class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M16 18h2V6h-2zM6 18l8.5-6L6 6z" />
            </svg></button>
        </div>
      </div>
    </div>
  </div>

  <main class="flex-1 overflow-y-auto h-full relative">
    <section id="home" class="page active px-6 justify-center items-center">
      <div class="absolute w-[300px] md:w-[600px] h-[300px] md:h-[600px] bg-sky-500/10 blur-[150px] rounded-full"></div>
      <div class="reveal-text flex -space-x-8 md:-space-x-16 mb-10 heartbeat-slow">
        <img src="./src/images/Haruto.png"
          class="w-24 h-24 md:w-52 md:h-52 rounded-full border-[4px] md:border-[6px] border-sky-500 object-cover z-20 shadow-2xl">
        <img src="./src/images/BaoAnh.jpg"
          class="w-24 h-24 md:w-52 md:h-52 rounded-full border-[4px] md:border-[6px] border-pink-500 object-cover z-10 shadow-2xl">
      </div>
      <div
        class="reveal-text flex gap-4 md:gap-14 items-center mb-8 bg-white/5 px-6 md:px-10 py-5 rounded-[2rem] md:rounded-[2.5rem] border border-white/10 backdrop-blur-md">
        <div class="flex flex-col items-center"><span id="hrs" class="text-2xl md:text-5xl font-light">00</span><span
            class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">GI·ªú</span></div>
        <div class="flex flex-col items-center"><span id="mins" class="text-2xl md:text-5xl font-light">00</span><span
            class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">PH√öT</span></div>
        <div class="flex flex-col items-center"><span id="secs"
            class="text-2xl md:text-5xl font-light text-sky-400">00</span><span
            class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">GI√ÇY</span></div>
      </div>
      <div class="reveal-text text-center">
        <p class="text-sky-400 font-bold tracking-[0.3em] md:tracking-[0.5em] uppercase text-[9px] md:text-[11px] mb-4">
          Our Eternal Chapter Since July 15, 2025
        </p>
        <div class="relative inline-block">
          <h2 class="text-[100px] md:text-[250px] font-thin text-white leading-none tracking-tighter" id="days-main">0
          </h2>
          <span
            class="absolute -right-10 md:-right-20 bottom-6 md:bottom-16 text-sky-500 text-xl md:text-5xl font-black italic tracking-tighter">DAYS</span>
        </div>
      </div>
    </section>

    <section id="media-gallery" class="page p-6 md:p-20 hidden">
      <div class="max-w-6xl mx-auto pb-32">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-8">
          <h2 class="text-5xl md:text-8xl font-black italic tracking-tighter text-white">·∫¢nh & Video</h2>
          <button onclick="document.getElementById('media-modal').classList.remove('hidden')"
            class="bg-sky-500 text-white px-8 md:px-10 py-4 md:py-5 rounded-[1.5rem] md:rounded-[2rem] font-black text-xs md:text-sm tracking-widest shadow-2xl hover:scale-105 transition-transform">TH√äM
            ·∫¢NH</button>
        </div>

        <div id="media-content" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
      </div>
    </section>

    <section id="timeline" class="page p-6 md:p-20 hidden">
      <div class="max-w-6xl mx-auto pb-32 text-left">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-8">
          <h2 class="text-5xl md:text-8xl font-black italic tracking-tighter text-white">Timeline</h2>
          <button onclick="document.getElementById('timeline-modal').classList.remove('hidden')"
            class="bg-white text-black px-8 md:px-10 py-4 md:py-5 rounded-[1.5rem] md:rounded-[2rem] font-black text-xs md:text-sm tracking-widest shadow-2xl hover:scale-105 transition-transform">VI·∫æT
            K·ªà NI·ªÜM</button>
        </div>
        <div class="flex flex-col md:flex-row gap-4 mb-16 items-start md:items-center">
          <div class="relative group">
            <span
              class="absolute left-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-sky-400 uppercase tracking-widest pointer-events-none">L·ªçc:</span>
            <input type="date" id="filter-date" onchange="updateViewDate(this.value)"
              class="bg-white/5 border border-white/10 rounded-xl py-3 pl-14 pr-4 outline-none text-white text-sm focus:border-sky-500 transition-all appearance-none">
          </div>
          <button onclick="document.getElementById('filter-date').value=''; loadMemories();"
            class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 hover:text-white transition-colors">Hi·ªán
            t·∫•t c·∫£</button>
        </div>
        <div class="timeline-container">
          <div class="timeline-line"></div>
          <div id="timeline-content" class="space-y-12"></div>
        </div>
      </div>
    </section>

    <section id="video-memories" class="page p-6 md:p-20 hidden">
      <div class="max-w-4x md:mx-auto pb-32">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-8">
          <h2 class="text-5xl md:text-8xl font-black italic tracking-tighter text-white">Videos</h2>
          <button onclick="document.getElementById('video-modal').classList.remove('hidden')"
            class="bg-sky-500 text-white px-8 md:px-10 py-4 md:py-5 rounded-[1.5rem] md:rounded-[2rem] font-black text-xs md:text-sm tracking-widest shadow-2xl hover:scale-105 transition-transform">TH√äM
            VIDEO</button>
        </div>
        <div id="video-content" class="grid grid-cols-1 gap-12"></div>
      </div>
    </section>

    <section id="music-lab" class="page p-6 md:p-20 hidden">
      <div class="max-w-4xl mx-auto text-left">
        <h2 class="text-5xl md:text-8xl font-black italic text-white mb-10">Music Lab</h2>
        <div class="bento-card p-8 rounded-[2.5rem] mb-10 border-t-4 border-sky-500">
          <h3 class="text-xl font-bold text-white mb-6 uppercase tracking-widest text-xs">Th√™m b√†i h√°t m·ªõi</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="song-name" placeholder="T√™n b√†i h√°t..."
              class="bg-white/5 border border-white/10 rounded-2xl p-4 text-white outline-none">
            <input type="text" id="song-url" placeholder="Link nh·∫°c (.mp3)..."
              class="bg-white/5 border border-white/10 rounded-2xl p-4 text-white outline-none">
          </div>
          <button onclick="uploadSong()"
            class="w-full py-4 bg-white text-black font-black rounded-2xl uppercase tracking-widest text-xs">C·∫≠p nh·∫≠t
            Album</button>
        </div>
        <div id="song-list" class="space-y-4 pb-20"></div>
      </div>
    </section>
  </main>

  <div id="video-modal"
    class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-lg rounded-[2.5rem] p-10">
      <h3 class="text-2xl font-black mb-6 text-white italic text-center">Th√™m Video YouTube</h3>
      <input type="text" id="v-title" placeholder="Ti√™u ƒë·ªÅ video..."
        class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-white mb-4 outline-none">
      <input type="text" id="v-url" placeholder="D√°n link YouTube v√†o ƒë√¢y..."
        class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-white mb-6 outline-none">
      <div class="flex gap-4">
        <button onclick="addVideo()"
          class="flex-1 py-4 rounded-2xl font-bold bg-sky-500 text-white uppercase tracking-widest text-xs">ƒêƒÉng
          Video</button>
        <button onclick="document.getElementById('video-modal').classList.add('hidden')"
          class="px-8 py-4 rounded-2xl font-bold bg-white/10 text-white">H·ªßy</button>
      </div>
    </div>
  </div>

  <div id="media-modal"
    class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-lg rounded-[2.5rem] p-10 shadow-2xl">
      <h3 class="text-2xl font-black mb-6 text-white italic text-center">Th√™m K·ª∑ Ni·ªám</h3>

      <div class="relative mb-6">
        <label class="text-[10px] font-black uppercase tracking-[0.2em] text-sky-400/70 ml-2 mb-2 block">Caption</label>
        <input type="text" id="m-caption" placeholder="ƒê·ªÉ l·∫°i v√†i l·ªùi ng·ªçt ng√†o..."
          class="w-full bg-white/5 border border-white/10 rounded-[1.5rem] p-5 text-white outline-none focus:border-sky-500/50 focus:bg-white/10 focus:ring-4 focus:ring-sky-500/10 transition-all duration-300">
      </div>

      <div class="mb-6">
        <label for="m-file"
          class="group relative flex flex-col items-center justify-center w-full min-h-[150px] max-h-[300px] border-2 border-dashed border-white/10 rounded-[2rem] bg-white/5 hover:bg-white/10 hover:border-sky-500/50 transition-all cursor-pointer overflow-hidden">
          <div id="preview-container" class="absolute inset-0 hidden bg-slate-950 flex items-center justify-center">
            <img id="m-preview" class="w-full h-full object-contain p-2">
            <div
              class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
              <span
                class="text-[10px] font-black uppercase tracking-widest text-white bg-sky-500 px-4 py-2 rounded-full shadow-xl">Thay
                ƒë·ªïi</span>
            </div>
          </div>
          <div id="upload-placeholder" class="flex flex-col items-center justify-center py-8">
            <svg class="w-10 h-10 mb-3 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
              </path>
            </svg>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-center px-4"
              id="file-name-display">Ch·ªçn ·∫£nh m√† em mu·ªën up</p>
          </div>
          <input type="file" id="m-file" accept="image/*,video/*" class="hidden" onchange="previewImage(this)" />
        </label>
      </div>

      <div class="flex gap-4">
        <button onclick="addMedia()" id="btn-upload-media"
          class="flex-1 py-4 rounded-2xl font-bold bg-sky-500 text-white uppercase tracking-widest text-xs hover:scale-105 transition-transform">ƒêƒÉng
          l√™n</button>
        <button onclick="closeMediaModal()"
          class="px-8 py-4 rounded-2xl font-bold bg-white/10 text-white hover:bg-white/20">H·ªßy</button>
      </div>
    </div>
  </div>

  <div id="change-pw-modal"
    class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-sm rounded-[2.5rem] p-10">
      <h3 class="text-2xl font-black mb-8 italic text-white text-center">ƒê·ªïi m·∫≠t kh·∫©u</h3>
      <input type="password" id="new-pw" placeholder="M·∫≠t kh·∫©u m·ªõi..."
        class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white mb-4">
      <button onclick="updatePassword()" class="w-full py-4 rounded-2xl font-bold text-white bg-sky-500">C·∫≠p
        nh·∫≠t</button>
      <button onclick="document.getElementById('change-pw-modal').classList.add('hidden')"
        class="w-full mt-4 text-white opacity-50">H·ªßy</button>
    </div>
  </div>

  <div id="timeline-modal"
    class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-lg rounded-[2.5rem] p-8 md:p-10 shadow-2xl">
      <h3 class="text-3xl font-black mb-8 italic text-white">Ghi l·∫°i kho·∫£nh kh·∫Øc</h3>
      <div class="space-y-4">
        <input type="text" id="m-title" placeholder="Ti√™u ƒë·ªÅ k·ª∑ ni·ªám..."
          class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white text-left">
        <textarea id="m-desc" placeholder="Ch√∫ng m√¨nh ƒë√£ l√†m g√¨ h√¥m nay?..." rows="4"
          class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white resize-none text-left"></textarea>
        <div class="flex gap-4">
          <button onclick="addMemory()"
            class="flex-1 py-4 rounded-2xl font-bold text-black bg-white hover:bg-sky-400 transition-colors uppercase tracking-widest text-sm">L∆∞u
            l·∫°i</button>
          <button onclick="document.getElementById('timeline-modal').classList.add('hidden')"
            class="px-8 py-4 rounded-2xl font-bold text-white bg-white/10 hover:bg-white/20 transition-colors">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="main-audio" preload="auto"></audio>

  <script
    type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js" } } </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import * as THREE from 'three';

    const firebaseConfig = { apiKey: "AIzaSyCtXpEIp65Uyr8YbJUPqPz8x6CzqC8Q4Xg", authDomain: "todo-list-8d4c3.firebaseapp.com", projectId: "todo-list-8d4c3", storageBucket: "todo-list-8d4c3.firebasestorage.app", messagingSenderId: "926023141272", appId: "1:926023141272:web:7c1fe53d54364143098ded" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    signInAnonymously(auth).catch(err => console.warn('Anonymous sign-in failed', err));
    let userData = null; let selectedUserId = null;

    function getYoutubeID(url) {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|shorts\/|live\/)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    window.addVideo = async () => {
      const titleInput = document.getElementById('v-title');
      const urlInput = document.getElementById('v-url');
      const title = titleInput.value.trim();
      const rawUrl = urlInput.value.trim();
      const videoId = getYoutubeID(rawUrl);
      if (!title || !videoId) return alert("Nh·∫≠p ti√™u ƒë·ªÅ v√† d√°n link YouTube chu·∫©n nh√©!");
      const isShorts = rawUrl.includes("shorts");
      await addDoc(collection(db, "videos"), { title, videoId, isShorts, author: userData.name, authorId: userData.id, createdAt: serverTimestamp() });
      titleInput.value = ''; urlInput.value = ''; document.getElementById('video-modal').classList.add('hidden');
    };

    function loadVideos() {
      onSnapshot(query(collection(db, "videos"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById("video-content");
        container.innerHTML = snap.docs.map((doc) => {
          const v = doc.data(); const date = v.createdAt ? v.createdAt.toDate() : new Date();
          const color = v.authorId === "bao" ? "#0ea5e9" : "#f472b6";
          const isShorts = v.isShorts === true;
          return `<div class="bento-card p-6 rounded-[2.5rem] border-t-4 shadow-2xl mb-6 w-full" style="border-top-color: ${color}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1 pr-4">
                        <h4 class="text-xl md:text-2xl font-black text-white italic mb-1">${v.title}</h4>
                        <p class="text-[11px] uppercase font-extrabold tracking-wider opacity-60" style="color: ${color}">${v.author} ‚Ä¢ ${date.toLocaleDateString("vi-VN")}</p>
                    </div>
                    <button onclick="deleteVideo('${doc.id}')" class="text-white/30 hover:text-red-500">‚úï</button>
                </div>
                <div class="video-wrapper w-full flex justify-center">
                    <div class="aspect-container w-full ${isShorts ? 'aspect-shorts aspect-shorts-mobile' : ''}">
                        <iframe src="https://www.youtube.com/embed/${v.videoId}?rel=0&modestbranding=1" allowfullscreen></iframe>
                    </div>
                </div>
            </div>`;
        }).join("");
      });
    }

    window.deleteVideo = async (id) => confirm("X√≥a video n√†y h·∫£?") && await deleteDoc(doc(db, "videos", id));

    // --- C·∫¨P NH·∫¨T CH√çNH T·∫†I ƒê√ÇY: H√ÄM ADD MEDIA ---
    window.addMedia = async () => {
      const caption = document.getElementById('m-caption').value.trim();
      const fileInput = document.getElementById('m-file');
      const file = fileInput && fileInput.files && fileInput.files[0];

      const docData = { caption, author: userData.name, authorId: userData.id, createdAt: serverTimestamp() };

      // TH√îNG TIN CLOUDINARY C·ª¶A B·∫†N
      const CLOUD_NAME = "ddvotq2cg";
      const UPLOAD_PRESET = "images_memories";

      try {
        if (file) {
          // 1. T·∫°o FormData ƒë·ªÉ g·ª≠i file l√™n Cloudinary
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', UPLOAD_PRESET);

          // 2. G·ªçi API Cloudinary
          const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
          });

          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ upload ·∫£nh l√™n Cloudinary");

          const cloudinaryData = await response.json();

          // 3. L·∫•y URL tr·∫£ v·ªÅ t·ª´ Cloudinary v√† g√°n v√†o docData
          docData.url = cloudinaryData.secure_url;
          docData.public_id = cloudinaryData.public_id; // L∆∞u l·∫°i ƒë·ªÉ x√≥a sau n√†y n·∫øu c·∫ßn
          docData.isVideo = file.type.startsWith('video');


        } else if (type === 'youtube') {
          const videoId = getYoutubeID(rawUrl);
          if (!videoId) return alert('Link YouTube kh√¥ng h·ª£p l·ªá.');
          docData.isVideo = true;
          docData.videoId = videoId;
          docData.isShorts = rawUrl.includes('shorts');
        } else {
          if (!rawUrl) return alert('H√£y ch·ªçn file ho·∫∑c d√°n link nh√©!');
          docData.url = rawUrl;
          docData.isVideo = false;
        }
        // 4. L∆∞u v√†o Firestore (Collection: images)
        await addDoc(collection(db, "images"), docData);
        // Reset form
        document.getElementById('m-caption').value = '';
        if (fileInput) fileInput.value = '';
        document.getElementById('media-modal').classList.add('hidden');
        alert("ƒê√£ th√™m v√†o b·ªô s∆∞u t·∫≠p th√†nh c√¥ng! üöÄ");
      } catch (err) {
        console.error(err);
        alert("L·ªói: " + err.message);
      }
      document.getElementById('preview-container').classList.add('hidden');
      document.getElementById('upload-placeholder').classList.remove('opacity-0');
      document.getElementById('m-preview').src = '';
    };

    function loadMedia() {
      onSnapshot(query(collection(db, "images"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById('media-content');
        if (!container) return;

        if (snap.empty) {
          container.innerHTML = `<p class="text-center opacity-30 py-20 text-white italic">Ch∆∞a c√≥ k·ª∑ ni·ªám n√†o ƒë∆∞·ª£c t·∫£i l√™n...</p>`;
          return;
        }

        container.innerHTML = snap.docs.map(doc => {
          const m = doc.data();
          const date = m.createdAt ? m.createdAt.toDate() : new Date();
          const color = m.authorId === 'bao' ? '#0ea5e9' : '#f472b6';

          // KI·ªÇM TRA QUY·ªÄN: Ch·ªâ hi·ªán n√∫t x√≥a n·∫øu ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p l√† ng∆∞·ªùi ƒëƒÉng ·∫£nh
          const isOwner = m.authorId === userData.id;

          let mediaHtml = '';
          if (m.isVideo && m.url) {
            mediaHtml = `<video controls class="w-full h-64 object-cover rounded-2xl shadow-inner"><source src="${m.url}"></video>`;
          } else if (m.url) {
            mediaHtml = `<img src="${m.url}" class="w-full h-64 object-cover rounded-2xl shadow-inner hover:scale-[1.02] transition-transform duration-500" loading="lazy">`;
          }

          return `
        <div class="bento-card p-5 rounded-[2.5rem] border-t-4 shadow-2xl mb-2 transition-all" style="border-top-color: ${color}">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full" style="background: ${color}"></div>
              <p class="text-[10px] uppercase font-black tracking-widest opacity-70" style="color:${color}">
                ${m.author} ‚Ä¢ ${date.toLocaleDateString('vi-VN')}
              </p>
            </div>
            
            ${isOwner ? `
              <button onclick="deleteMedia('${doc.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 text-white/30 hover:bg-red-500/20 hover:text-red-500 transition-all">
                ‚úï
              </button>` : ''}
          </div>
          
          <div class="relative group cursor-pointer overflow-hidden rounded-2xl mb-4">
            ${mediaHtml}
          </div>
          
          <p class="text-slate-300 italic text-sm px-2 leading-relaxed">
            ${m.caption ? `‚Äú${m.caption}‚Äù` : '<span class="opacity-20">Kh√¥ng c√≥ ch√∫ th√≠ch</span>'}
          </p>
        </div>`;
        }).join('');
      });
    }

    window.deleteMedia = async (id) => {
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·ª∑ ni·ªám n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
        try {
          await deleteDoc(doc(db, "images", id));
          // N·∫øu d√πng Cloudinary, vi·ªác x√≥a ·∫£nh tr√™n Cloudinary c·∫ßn th√¥ng qua Backend (ho·∫∑c ƒë·ªÉ ƒë√≥ c≈©ng ƒë∆∞·ª£c v√¨ dung l∆∞·ª£ng Free kh√° l·ªõn)
        } catch (err) {
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a ·∫£nh n√†y!");
        }
      }
    };

    window.loadMemories = (selectedDate = null) => {
      let q = query(collection(db, "memories"), orderBy("date", "desc"));
      if (selectedDate) {
        const start = new Date(selectedDate).toISOString();
        const end = new Date(new Date(selectedDate).setHours(23, 59, 59, 999)).toISOString();
        q = query(collection(db, "memories"), where("date", ">=", start), where("date", "<=", end), orderBy("date", "desc"));
      }
      onSnapshot(q, (snap) => {
        const contentEl = document.getElementById('timeline-content');
        if (snap.empty) { contentEl.innerHTML = `<p class="text-center opacity-30 py-20 text-white">Ch∆∞a c√≥ k·ªâ ni·ªám n√†y...</p>`; return; }
        contentEl.innerHTML = snap.docs.map(doc => {
          const d = doc.data(); const color = d.author === 'bao' ? '#0ea5e9' : '#f472b6';
          return `<div class="memory-row flex w-full relative min-h-[150px] ${d.author === 'bao' ? 'md:flex-row' : 'md:flex-row-reverse'}">
                <div class="timeline-dot" style="background: ${color}; box-shadow: 0 0 15px ${color}"></div>
                <div class="memory-card-wrapper w-full md:w-1/2 ${d.author === 'bao' ? 'md:pr-14' : 'md:pl-14'}">
                    <div class="reveal-text reveal-active bento-card p-6 md:p-10 rounded-[2.5rem] w-full border-t-4 shadow-2xl" style="border-top-color: ${color}">
                        <p class="text-[10px] md:text-[11px] font-black uppercase mb-3 tracking-[0.2em]" style="color: ${color}">${d.author === 'bao' ? 'B·∫£o' : 'B·∫£o Anh'} ‚Ä¢ ${new Date(d.date).toLocaleDateString('vi-VN')}</p>
                        <h4 class="text-2xl md:text-3xl font-black text-white italic mb-3">${d.title}</h4>
                        <p class="text-slate-400 text-sm md:text-lg italic leading-relaxed">"${d.desc}"</p>
                    </div>
                </div></div>`;
        }).join('');
      });
    }

    window.addMemory = async () => {
      const t = document.getElementById('m-title').value; const d = document.getElementById('m-desc').value;
      if (!t || !d) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin nha!");
      await addDoc(collection(db, "memories"), { title: t, desc: d, author: userData.id, date: new Date().toISOString() });
      document.getElementById('m-title').value = ''; document.getElementById('m-desc').value = '';
      document.getElementById('timeline-modal').classList.add('hidden');
    };

    window.selectUser = (id) => { selectedUserId = id; document.getElementById('profile-select').classList.add('hidden'); document.getElementById('password-box').classList.remove('hidden'); };
    window.togglePassword = (id) => { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; };
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

    document.getElementById('btn-login-verify').onclick = async () => {
      const pass = document.getElementById('login-password').value;
      const userDoc = await getDoc(doc(db, "users", selectedUserId));
      if (userDoc.exists() && userDoc.data().password === pass) {
        userData = { id: selectedUserId, name: userDoc.data().name || (selectedUserId === 'bao' ? 'B·∫£o' : 'B·∫£o Anh') };
        sessionStorage.setItem('memory_session', JSON.stringify(userData));
        enterStudio();
      } else alert("M·∫≠t kh·∫©u sai r·ªìi B·∫£o ∆°i! ‚ú®");
    };

    window.updatePassword = async () => {
      const np = document.getElementById('new-pw').value;
      if (!np) return alert("Nh·∫≠p pass m·ªõi n√®!");
      await updateDoc(doc(db, "users", userData.id), { password: np });
      alert("Xong r·ªìi! üîë"); document.getElementById('change-pw-modal').classList.add('hidden');
    };

    function enterStudio() {
      const now = new Date();
      const todayISO = now.toISOString().split('T')[0];
      const dateInput = document.getElementById('filter-date');
      if (dateInput) dateInput.value = todayISO;
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('user-greeting').innerText = `Ch√†o ${userData.name} ‚ú®`;
      const avatarImg = userData.id === 'bao' ? './src/images/Haruto.png' : './src/images/BaoAnh.jpg';
      document.getElementById('user-avatar').innerHTML = `<img src="${avatarImg}" class="w-full h-full object-cover">`;
      loadMemories(todayISO); loadVideos(); loadMedia(); initMusicSystem(); initTimer(); initThreeJS();
      setTimeout(() => document.querySelectorAll('.active .reveal-text').forEach(el => el.classList.add('reveal-active')), 200);
    }

    window.switchPage = (pid, btn) => {
      if (window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
      document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.classList.add('hidden'); });
      document.getElementById(pid).classList.add('active'); document.getElementById(pid).classList.remove('hidden');
      document.querySelectorAll('.nav-link').forEach(l => { l.classList.add('opacity-50'); l.classList.remove('active'); });
      btn.classList.add('active'); btn.classList.remove('opacity-50');
      setTimeout(() => document.querySelectorAll(`#${pid} .reveal-text`).forEach(el => el.classList.add('reveal-active')), 50);
    };

    function initTimer() {
      const start = new Date('2025-07-15T00:00:00');
      const update = () => {
        const diff = new Date() - start;
        document.getElementById('days-main').innerText = Math.floor(diff / 86400000);
        document.getElementById('hrs').innerText = String(Math.floor((diff % 86400000) / 3600000)).padStart(2, '0');
        document.getElementById('mins').innerText = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
        document.getElementById('secs').innerText = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
      };
      update(); setInterval(update, 1000);
    }

    function initThreeJS() {
      const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      const starGeo = new THREE.BufferGeometry(); const starPoints = new Float32Array(2000 * 3);
      for (let i = 0; i < 6000; i++) starPoints[i] = (Math.random() - 0.5) * 100;
      starGeo.setAttribute('position', new THREE.BufferAttribute(starPoints, 3));
      const starMesh = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.3 }));
      scene.add(starMesh); camera.position.z = 5;
      function animate() { requestAnimationFrame(animate); starMesh.rotation.y += 0.0003; renderer.render(scene, camera); } animate();
    }

    let songs = []; let cIdx = 0; const audio = document.getElementById('main-audio');
    function initMusicSystem() {
      onSnapshot(query(collection(db, "songs"), orderBy("createdAt", "desc")), (snap) => {
        songs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (songs.length > 0 && !audio.src) {
          audio.src = songs[0].url;
          document.getElementById('current-song-title').innerText = songs[0].name;
          document.getElementById('current-song-author').innerText = `G·ª≠i b·ªüi: ${songs[0].author}`;
        }
        renderSongList();
      });
    }

    function renderSongList() {
      const list = document.getElementById('song-list'); if (!list) return;
      list.innerHTML = songs.map((s, i) => `<div onclick="loadAndPlay(${i})" class="bento-card p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-white/5 transition-all">
            <p class="text-white font-bold text-sm">${s.name}</p>
            <button onclick="event.stopPropagation(); deleteSong('${s.id}')" class="text-red-500 opacity-30 hover:opacity-100">X√≥a</button>
        </div>`).join('');
    }

    window.loadAndPlay = (i) => {
      cIdx = i; audio.src = songs[i].url;
      document.getElementById('current-song-title').innerText = songs[i].name;
      document.getElementById('current-song-author').innerText = `G·ª≠i b·ªüi: ${songs[i].author}`;
      audio.play().then(() => updateUI(true)).catch(() => updateUI(false));
    };
    window.toggleMusic = () => audio.paused ? (audio.play(), updateUI(true)) : (audio.pause(), updateUI(false));
    window.nextSong = () => { cIdx = (cIdx + 1) % songs.length; loadAndPlay(cIdx); };
    window.prevSong = () => { cIdx = (cIdx - 1 + songs.length) % songs.length; loadAndPlay(cIdx); };
    window.deleteSong = async (id) => confirm("X√≥a b√†i n√†y?") && await deleteDoc(doc(db, "songs", id));
    window.uploadSong = async () => {
      const n = document.getElementById('song-name').value; const u = document.getElementById('song-url').value;
      if (n && u) { await addDoc(collection(db, "songs"), { name: n, url: u, author: userData.name, createdAt: serverTimestamp() }); document.getElementById('song-name').value = ''; document.getElementById('song-url').value = ''; }
    };

    function updateUI(playing) {
      document.getElementById('play-btn').innerText = playing ? '‚è∏' : '‚ñ∂';
      document.getElementById('music-disk').classList[playing ? 'remove' : 'add']('music-paused');
    }

    const session = sessionStorage.getItem('memory_session');
    if (session) { userData = JSON.parse(session); enterStudio(); }
    window.togglePlayerSize = () => {
      const player = document.getElementById('floating-player');
      player.classList.toggle('collapsed');
      document.getElementById('toggle-icon').innerText = player.classList.contains('collapsed') ? '‚ô´' : '‚úï';
    };
    window.previewImage = (input) => {
      const container = document.getElementById('preview-container');
      const previewImg = document.getElementById('m-preview');
      const placeholder = document.getElementById('upload-placeholder');
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = file.type.startsWith('video') ? "https://cdn-icons-png.flaticon.com/512/1179/1179120.png" : e.target.result;
          container.classList.remove('hidden');
          placeholder.classList.add('opacity-0');
        };
        reader.readAsDataURL(file);
      }
    };
    window.closeMediaModal = () => {
      document.getElementById('media-modal').classList.add('hidden');
      document.getElementById('m-caption').value = '';
      document.getElementById('m-file').value = '';
      document.getElementById('preview-container').classList.add('hidden');
      document.getElementById('upload-placeholder').classList.remove('opacity-0');
    };
  </script>
</body>

</html>